<script src="https://cdn.jsdelivr.net/npm/three@0.156.0/build/three.min.js"></script>
<script>
let scene = new THREE.Scene();
let camera = new THREE.PerspectiveCamera(75, window.innerWidth/window.innerHeight, 0.1, 1000);
let renderer = new THREE.WebGLRenderer({antialias:true});
renderer.setSize(window.innerWidth, window.innerHeight);
document.body.appendChild(renderer.domElement);

// ผู้เล่น
let player = new THREE.Mesh(
    new THREE.BoxGeometry(1,2,1),
    new THREE.MeshBasicMaterial({color:0x0000ff})
);
player.position.y = 1;
scene.add(player);

// พื้น
let ground = new THREE.Mesh(
    new THREE.PlaneGeometry(100,100),
    new THREE.MeshBasicMaterial({color:0x228B22})
);
ground.rotation.x = -Math.PI/2;
scene.add(ground);

// กล้องเริ่มต้น
camera.position.set(0,2,5);
camera.lookAt(player.position);

// ตัวแปรหมุนกล้อง
let yaw = 0;   // ซ้าย-ขวา
let pitch = 0; // ขึ้น-ลง
let isDragging = false;
let previousX, previousY;

// ลากเมาส์/นิ้วเพื่อหมุน
renderer.domElement.addEventListener('mousedown', e=>{
    isDragging = true;
    previousX = e.clientX;
    previousY = e.clientY;
});
renderer.domElement.addEventListener('mouseup', e=>{ isDragging=false; });
renderer.domElement.addEventListener('mousemove', e=>{
    if(isDragging){
        let deltaX = e.clientX - previousX;
        let deltaY = e.clientY - previousY;
        yaw -= deltaX * 0.005;
        pitch -= deltaY * 0.005;
        pitch = Math.max(-Math.PI/2, Math.min(Math.PI/2, pitch));
        previousX = e.clientX;
        previousY = e.clientY;
    }
});
// สำหรับมือถือ
renderer.domElement.addEventListener('touchstart', e=>{
    isDragging = true;
    previousX = e.touches[0].clientX;
    previousY = e.touches[0].clientY;
});
renderer.domElement.addEventListener('touchend', e=>{ isDragging=false; });
renderer.domElement.addEventListener('touchmove', e=>{
    if(isDragging){
        let deltaX = e.touches[0].clientX - previousX;
        let deltaY = e.touches[0].clientY - previousY;
        yaw -= deltaX * 0.005;
        pitch -= deltaY * 0.005;
        pitch = Math.max(-Math.PI/2, Math.min(Math.PI/2, pitch));
        previousX = e.touches[0].clientX;
        previousY = e.touches[0].clientY;
    }
});

// เป้าหมาย
let targets = [];
function spawnTarget(){
    let target = new THREE.Mesh(
        new THREE.BoxGeometry(1,1,1),
        new THREE.MeshBasicMaterial({color:0xff0000})
    );
    target.position.set(Math.random()*20-10,0.5,Math.random()*20-10);
    scene.add(target);
    targets.push(target);
}
for(let i=0;i<5;i++) spawnTarget();

// กระสุน
let bullets = [];
let ammo = 20;

// ปุ่มมือถือ
let keys = {};
['left','right','up','down'].forEach(dir=>{
    const btn = document.getElementById(dir);
    btn.addEventListener('touchstart', e=>{ keys[dir]=true; e.preventDefault(); });
    btn.addEventListener('touchend', e=>{ keys[dir]=false; e.preventDefault(); });
});
document.getElementById('shoot').addEventListener('touchstart', e=>{
    if(ammo>0){
        bullets.push({x:player.position.x, y:player.position.y, z:player.position.z, dx:0, dz:-0.5});
        ammo--;
        document.getElementById('ammo').innerText = ammo;
    }
    e.preventDefault();
});

// ควบคุมผู้เล่น
function movePlayer(){
    if(keys['left']) player.position.x -= 0.1;
    if(keys['right']) player.position.x += 0.1;
    if(keys['up']) player.position.z -= 0.1;
    if(keys['down']) player.position.z += 0.1;
}

// ออโต้ล็อกยิง
function autoLock(){
    targets.forEach(t=>{
        let dx = t.position.x - player.position.x;
        let dz = t.position.z - player.position.z;
        let dist = Math.sqrt(dx*dx + dz*dz);
        if(dist<5 && ammo>0){
            bullets.push({x:player.position.x, y:player.position.y, z:player.position.z, dx:dx/dist*0.2, dz:dz/dist*0.2});
            ammo--;
            document.getElementById('ammo').innerText = ammo;
        }
    });
}

// อัปเดตกระสุน
function updateBullets(){
    bullets.forEach((b,i)=>{
        b.x += b.dx;
        b.z += b.dz;
        targets.forEach((t,j)=>{
            let dx = t.position.x - b.x;
            let dz = t.position.z - b.z;
            if(Math.sqrt(dx*dx+dz*dz)<0.5){
                document.getElementById('score').innerText = parseInt(document.getElementById('score').innerText)+1;
                scene.remove(t);
                targets.splice(j,1);
                spawnTarget();
                bullets.splice(i,1);
            }
        });
    });
}

// ลูปหลัก
function animate(){
    requestAnimationFrame(animate);
    movePlayer();
    autoLock();
    updateBullets();

    // อัปเดตกล้องตาม yaw/pitch
    let camX = player.position.x + Math.sin(yaw)*5;
    let camY = player.position.y + 2 + Math.sin(pitch)*2;
    let camZ = player.position.z + Math.cos(yaw)*5;
    camera.position.set(camX, camY, camZ);
    camera.lookAt(player.position);

    renderer.render(scene, camera);
}
animate();
</script>
